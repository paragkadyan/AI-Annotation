name: Validate AI-Generated Code Annotations

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  validate-ai-code:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install validator
        run: |
          cd src/python-validator
          pip install -e .

      - name: Run AI code validator
        id: validate
        run: |
          cd ${{ github.workspace }}
          python -m ai_code_validator.cli --repo-path . --output-format json > validation_result.json 2>&1
          cat validation_result.json
        continue-on-error: true

      - name: Parse validation results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let result = { valid: true, errors: [], summary: {} };

            try {
              const content = fs.readFileSync('validation_result.json', 'utf8');
              result = JSON.parse(content);
            } catch (e) {
              console.warn('Could not parse validation result:', e.message);
            }

            if (!result.valid) {
              const summary = result.summary || {};
              const errorCount = (result.errors || []).length;

              console.log(`\n❌ AI Code Validation Failed`);
              console.log(`Files with errors: ${summary.files_with_errors || errorCount}`);

              if (result.errors && result.errors.length > 0) {
                console.log('\nErrors:');
                result.errors.forEach(err => {
                  console.log(`  - ${err.file}:${err.line} - ${err.message}`);
                });
              }

              process.exit(1);
            } else {
              console.log('\n✅ All AI code annotations are valid!');
              const summary = result.summary || {};
              console.log(`Total files scanned: ${summary.total_files || 0}`);
            }
